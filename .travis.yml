sudo: required

services:
  - docker

language: java

jdk:
  - oraclejdk8

env:
  global:
    - secure: "DPuQSjY+hFY7SEoJkrfysP+jNQ9RPHoW9xV7mh1mbXWFwztjWWlzfvg6tj78fjn1R4hKbpFbKNDbgIOxkMdWVqXTvB3WWEr7oaoNYLInFUtyj0cu+XcIgt2NztMIXNqeqFpCIiBA08OnL1jCZcP0gK3rJfKJVN7nYpsVFr+ZS55fC5ksI4vJ2Qm5YDMMvmCoq35Rls0x8oK070tX3VOvndx5KjUv3kMV18gmJLLX2VsOdfgI3SM1pFO2RgfPC/RQV16fdMkYqPOyIIlFH5Km9rPaHc5rFMcBiCPBMNrp+NGS4DnM6PHM/cKOdCGSlOegLVtv2lOL07+Hx+mRbS8u4RTTgUxa5cYzi16owLChZ1wUodUojTwnq0Bz8BN7tXB5+2TK4tBj+d3hPTGSNiFed3vkSbGTKxSusGjXLBABJuB0PAH/qH8w4HXwF/n49RX6HDRAxJK2STQ0s2J+HkPUiWp3hIuJD35YCI9OCEYDZSFrj9wdv5GhCkWcCCTU0MAoRBvKBHY1jLMHo0+X65vBSmJVf56LGgV/mFaUtN8kFqq1LnWVmM78S+9lOquOxU1OSGO4WLy5ni3IJ0ixQX3e4yiUsVj9LRt8NT1E/OSsWR4jbfD6dOEC3D75Nk/HUvxCjowBNrEBIaWc5RGecqvDuEnsS7GUKcz91/6ByVp++Ho=" #HEROKU_API_KEY
    - secure: "TFvIILR9nO5xgRUhiXab9nt6YE9XN/57ZWHYZMGNyuAgbxFoMG1HT9P1OGkL27jIYHz7wHS6UFBsZFx26yukB9znXeAZPGTKR2VVLVII7tDT+Ss2dvFulaFzv6Tm1xlPQC6R4YLHjMGIHPodDkQsr/WQpR1/u34D5HQxfMKQywnjC2V54t4u5Y3fY6UNb2D4IyjuUr5zPIeNt4F8DXbLIfF8215wWgvF41vA7q9ZRF9BF5X54HfnQXkrqHEDoLExptuPyoPyREWKyUVxCxVLA6z/HG9EFMxFT6Tts/Eq1OuEOzdYgnkf6BGtn/MiaTHOQtBCIhwfizQYfyn44ojwdquAKsNVVmP+Rtvxl5uMdaHwcG27RrFk5Sw1IzGAgX/APyGtrIMqCFrohATnmwIGvVleryCgWxSc8vJi7WryBjkhLQymyjsyTssXt5lC4NoLsp8wP3oLb2qmq4LaOhH7H8HEh9l50Pjp4pKWQ3XMlZl+x4HTGVkBMVK/5xJf3Bti9/aLd3xYpsidOz6DZ/63gpy0GmWJwBSUOx7iEHqIFQTHAXrbpFTxLD//m9c5chMUxMnYjd6zgv3a4Zu0c/LdtSYdvk9xBroJ/YTMaVGyPyFDnGdZp6lbz4Ye+vGgZgPs6A1Cw4S0k/KEjRfWO5vaaEtA25mG9BArVojZzxThCzM=" #DOCKER_USER
    - secure: "qv4W2QBXi6HPbSb6ZTvzsWAY78z/2KvBIB551ijeUgxiG+qvTTBaQ4pfRM9wq3QrzaynXZdsqRDRKc+gHOGpZFoa80cB2zjMsDql1tXs3+Qcsg8QG++EpH71aZK8sTN01ubvXCdOc/T5mpnlrwJPl1mJF7sPUddWd3XdAjG6RkhKF81wKNGIpK4FY7gYv4sQHNR5dNZUXeVPWzXsRncexl9ccnGWQDpc0aEgJ8SO6m7NIOtHk9sK23qxKtYVE1W5Z/QUFZxAMa3QE3kn8cOJ2j1Z0QXyADzb1eTHUK68R+fPZ4g01BIPyP5qcfnSDnALDFx6/AC/ZI+ZEtICxChzYJsx66ee07I0AvSAqJVB3irCskvBCrzYy625l1F8PPnZ3xH7rO+R4z+0aJJgeFKY5T8hgKwgF39R8dF4q5fEA16zTyPez4HAE2vH5OgG+LgMb2BrC90X56Ha73DP7D2cF20lQ/veZMACWeKH4sQsLoXFwDuG9weZvv6Fj6teVA8hQnQm6quXTnQpQ7L5i32CO19N9KRTVX/jh5m2I6KVz6oAdY6CZ/03bfHfb9XV2ngUdokEHQCnxJ2e/Qh7tiKmGRU5bEzs2EJbzeiCkhapRzL1UDkz0KwkTtOyPSOV7YUfeTyLbDVYC4hXfat1gNuuwvbwwqKyX6WWi7gcaOalE5c=" #DOCKER_PASS
    - secure: gBG9Vbc43WHzjQlVtJWYYv6LWRcUP2TiNFZGRQ7KmpR/Q7JMVuUi7lmu1SlpkYvNIMzyd/14BWlSuaV7NtEK7loECD23RbnLzeNv1gs08S+MkI5hzW3IBzp2VlCN9CuOFKxrmA3Fb+uvKpHjSG8JftUPOo3jq9F9IZ22lNEQ5vHXvTEA+m3e0mMgvB3gcqLwJdfYU+hSXcbRldQ2hPRyc8k2O6R859B8mpryDB0FPlYU/RQ1Yyyg3HqjSNdPbS08oxFR/8tYpdUoV19nb0oM7bogH9ODBejgt72CVBfxYnmsCNwK3QbQbUOnW2xfpYfIQNGFalxsZaw2GGCq/jY7rxI+1kvQyEidYz939CW9xIP0l8TeDfothf9Q+H2l7tSnu4e5yMMK/8Qj/iRSVuQji7/aAP4dIReskTG63gRE7WUaXgyXPUrfpAvojg0Rz4NeT2H5KtV2SYkYGeMDwZeHQ0AqoVaPSqBgKywf78+Gf6og3eI4I7Xytw+gFScgQ27+lvEGZQf+LT/9iTmNMnnQgrobuRYjgoozHZgrTBfn32NCsUzmnlyfdNXy85eJpR4LpdX7jMrExDveUhos9UZre2TKxGzmqGABZMnizmmmraKRehRsmtcaXBWFC+GR8uIXdCsde7ZXX6TBEjdEVT6m8G4y53uZz4lEMneKqrZ0JmU= #SONAR_TOKEN
    - DOCKER_IMAGE_NAME=ismaelcabanas14/storeroom-rest-api

script:
  - ./gradlew check test integrationTest jacocoTestCoverageVerification jacocoTestReport
  - sonar-scanner -X
  - docker build -t $DOCKER_IMAGE_NAME .
  - docker run -it -p 8000:8000 -d $DOCKER_IMAGE_NAME
  - ./gradlew acceptanceTest

addons:
  sonarcloud:
    organization: ismaelcabanas-github
    token:
      secure: "$SONAR_TOKEN"

after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi`
  - docker tag $DOCKER_IMAGE_NAME $DOCKER_IMAGE_NAME:$TAG
  - docker push $DOCKER_IMAGE_NAME

deploy:
  skip_cleanup: true
  provider: heroku
  api_key:
    secure: euwJsFVwXlb8fB30a3IIQAN/2k3CbTKbUyK/lVEcz3XoCg2AKBbXQlngShThn00ce9/ZSb4004Tyib8Equou9zOqe7UcpqDNBN2hTIT7QGXkE5ZPZ4vhZsJnNORICI3gRthbIfnYxtUIA5oD29SIZQ51Oo8j39B8Ca2RfKCALNsiL7iBFtfBwX7Zm56U53P5ogty6gCoEousMpnSIzTMBi3w7bz59YzwlPjIQhRd1V6rlXKyW4sdgxnOe7IfP5Jj8Zdd0V/jwpA8x+54k58h2DQXPSNZlZuPJR29v3YLC+jYLZimAm30k5oS+pFyYZLD2bTRlt8fJ2ILJNdpJWSK/xX0dWZQFyEpZ6VSovETTslNIwFoFXpIpuucjnTpWYyj8iDF51IWYpISWR+4KuM1lsz/9356Yte3VjRJnx7HvP3pRSp6EBnI6xwr4uMP8VtahWzl+O0fULWq6V8WDVer2PGca2XIRHmGghpBaw7jpJN/QG6K9KqGW0wcCErYZvSc2f00oHyFpijd1LJJcXHqq2caOdMMC9Nwzm9OCrxy9JoOWNbIHtk6RD7Z68B926pHpE8QI7q3LgHyrDkLG6befH+hmonWgrrO9T0KjNg+B1aDBqhhm3+WmjjaKMGeBRPy39gtUyS5aCcXxwPJOwsA9x3QTFpj86999Gyw1PDjBvU=
  app:
    master: storeroom-rest-api
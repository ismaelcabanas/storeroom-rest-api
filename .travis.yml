sudo: required

services:
  - docker

language: java

jdk:
  - oraclejdk8

env:
  global:
    - secure: "bZwUzFvYqyqlj9gvqD5RCSZt/M/1CRQSUPl0wNjq4vt9rnf59hovd9kbbEAJDqIPwIk/4+AXzDGgboujwrTM4ypD4wb8gjkXiNxVirvgdjXjHxIUc5qvaXGwyONLVJ+oV4zoqFu8bnb902cXwI8YDcRUxTJLGerumbgdiuDggJvrQKdK5vA+lK1Y8nSEZMWskBbwIexgzkpaj7gG2AmESmeenZgCCrf/H1P7t41bo/Rq5Fx0VfcR5fbXKq5fF5dzU5fUI3vrSqQ/oMNN5QaTCt6xw/NPipnnMUeoo8xauoN96bebKI+bP8wKdQFx4cgPuzw5bnzmJQgkoM3za7is0j11JNO/jqB65jdW9OZzt5zGh36UEUUFP+Schhe3AfuEtvnTKpR1/YwqnOQPSmlGehrydYMRaig9KIUYbh77PVLP1QFX0VM09twyoR3MMdFC5WNXceRLmgCIrs9Fq1frHfH7bgm/pS46wx/W24DcYihOjsVwGtlwPx9VWV0KlsC5ukiQa8CfVSMLl5hcP1E0Z2f0YIQf66E7Gys4lLwzvvNG9GO7l9fpgyZYgYrxapxH3TYcq/1W7/m2ek22hBEzbQ0NfHNhmUOISi8O3K9VFc1Wby2Q3TomiQt0DyaPYU54vOTd16pcMmmHMbxtSIVFpf668uEn29MTlgWiRSj8LhI=" #HEROKU_API_KEY
    - secure: "TFvIILR9nO5xgRUhiXab9nt6YE9XN/57ZWHYZMGNyuAgbxFoMG1HT9P1OGkL27jIYHz7wHS6UFBsZFx26yukB9znXeAZPGTKR2VVLVII7tDT+Ss2dvFulaFzv6Tm1xlPQC6R4YLHjMGIHPodDkQsr/WQpR1/u34D5HQxfMKQywnjC2V54t4u5Y3fY6UNb2D4IyjuUr5zPIeNt4F8DXbLIfF8215wWgvF41vA7q9ZRF9BF5X54HfnQXkrqHEDoLExptuPyoPyREWKyUVxCxVLA6z/HG9EFMxFT6Tts/Eq1OuEOzdYgnkf6BGtn/MiaTHOQtBCIhwfizQYfyn44ojwdquAKsNVVmP+Rtvxl5uMdaHwcG27RrFk5Sw1IzGAgX/APyGtrIMqCFrohATnmwIGvVleryCgWxSc8vJi7WryBjkhLQymyjsyTssXt5lC4NoLsp8wP3oLb2qmq4LaOhH7H8HEh9l50Pjp4pKWQ3XMlZl+x4HTGVkBMVK/5xJf3Bti9/aLd3xYpsidOz6DZ/63gpy0GmWJwBSUOx7iEHqIFQTHAXrbpFTxLD//m9c5chMUxMnYjd6zgv3a4Zu0c/LdtSYdvk9xBroJ/YTMaVGyPyFDnGdZp6lbz4Ye+vGgZgPs6A1Cw4S0k/KEjRfWO5vaaEtA25mG9BArVojZzxThCzM=" #DOCKER_USER
    - secure: "qv4W2QBXi6HPbSb6ZTvzsWAY78z/2KvBIB551ijeUgxiG+qvTTBaQ4pfRM9wq3QrzaynXZdsqRDRKc+gHOGpZFoa80cB2zjMsDql1tXs3+Qcsg8QG++EpH71aZK8sTN01ubvXCdOc/T5mpnlrwJPl1mJF7sPUddWd3XdAjG6RkhKF81wKNGIpK4FY7gYv4sQHNR5dNZUXeVPWzXsRncexl9ccnGWQDpc0aEgJ8SO6m7NIOtHk9sK23qxKtYVE1W5Z/QUFZxAMa3QE3kn8cOJ2j1Z0QXyADzb1eTHUK68R+fPZ4g01BIPyP5qcfnSDnALDFx6/AC/ZI+ZEtICxChzYJsx66ee07I0AvSAqJVB3irCskvBCrzYy625l1F8PPnZ3xH7rO+R4z+0aJJgeFKY5T8hgKwgF39R8dF4q5fEA16zTyPez4HAE2vH5OgG+LgMb2BrC90X56Ha73DP7D2cF20lQ/veZMACWeKH4sQsLoXFwDuG9weZvv6Fj6teVA8hQnQm6quXTnQpQ7L5i32CO19N9KRTVX/jh5m2I6KVz6oAdY6CZ/03bfHfb9XV2ngUdokEHQCnxJ2e/Qh7tiKmGRU5bEzs2EJbzeiCkhapRzL1UDkz0KwkTtOyPSOV7YUfeTyLbDVYC4hXfat1gNuuwvbwwqKyX6WWi7gcaOalE5c=" #DOCKER_PASS
    - secure: gBG9Vbc43WHzjQlVtJWYYv6LWRcUP2TiNFZGRQ7KmpR/Q7JMVuUi7lmu1SlpkYvNIMzyd/14BWlSuaV7NtEK7loECD23RbnLzeNv1gs08S+MkI5hzW3IBzp2VlCN9CuOFKxrmA3Fb+uvKpHjSG8JftUPOo3jq9F9IZ22lNEQ5vHXvTEA+m3e0mMgvB3gcqLwJdfYU+hSXcbRldQ2hPRyc8k2O6R859B8mpryDB0FPlYU/RQ1Yyyg3HqjSNdPbS08oxFR/8tYpdUoV19nb0oM7bogH9ODBejgt72CVBfxYnmsCNwK3QbQbUOnW2xfpYfIQNGFalxsZaw2GGCq/jY7rxI+1kvQyEidYz939CW9xIP0l8TeDfothf9Q+H2l7tSnu4e5yMMK/8Qj/iRSVuQji7/aAP4dIReskTG63gRE7WUaXgyXPUrfpAvojg0Rz4NeT2H5KtV2SYkYGeMDwZeHQ0AqoVaPSqBgKywf78+Gf6og3eI4I7Xytw+gFScgQ27+lvEGZQf+LT/9iTmNMnnQgrobuRYjgoozHZgrTBfn32NCsUzmnlyfdNXy85eJpR4LpdX7jMrExDveUhos9UZre2TKxGzmqGABZMnizmmmraKRehRsmtcaXBWFC+GR8uIXdCsde7ZXX6TBEjdEVT6m8G4y53uZz4lEMneKqrZ0JmU= #SONAR_TOKEN
    - DOCKER_IMAGE_NAME=ismaelcabanas14/storeroom-rest-api

script:
  - ./gradlew check test integrationTest jacocoTestCoverageVerification jacocoTestReport
  - sonar-scanner -X
  - docker build -t $DOCKER_IMAGE_NAME .
  - docker run -it -p 8000:8000 -d $DOCKER_IMAGE_NAME
  - ./gradlew acceptanceTest

addons:
  sonarcloud:
    organization: ismaelcabanas-github
    token:
      secure: "$SONAR_TOKEN"

after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi`
  - docker tag $DOCKER_IMAGE_NAME $DOCKER_IMAGE_NAME:$TAG
  - docker push $DOCKER_IMAGE_NAME

deploy:
  skip_cleanup: true
  provider: heroku
  api_key: $HEROKU_API_KEY
  app: storeroom-rest-api
  on: master